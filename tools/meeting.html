<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=360, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Meeting</title>
<style>
:root {
  --w: 360px;
  --h: 640px;

  --join-seconds: 30;
  --talk-seconds: 60;
  --vote-seconds: 20;

  --red: #ff595e;
  --yellow: #ffd166;
  --blue: #4cc9f0;
  --green: #90be6d;
  --txt: #e6eef6;
  --bg: #10131a;
  --card: #1a1d27;
}

html, body {
  margin: 0;
  height: 100%;
  background: var(--bg);
  font-family: 'Arial', sans-serif;
  color: var(--txt);
  overflow: hidden;
}

.viewport {
  width: var(--w);
  height: var(--h);
  overflow: hidden;
  position: relative;
  margin: auto;
  border-radius: 20px;
  background: var(--bg);
  box-shadow: 0 0 30px rgba(0,0,0,0.7);
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Alerte principale */
.alert {
  margin-top: 180px;
  font-size: 100px;
  font-weight: 900;
  color: var(--red);
  text-shadow: 0 0 20px var(--red);
  animation: pulse 0.8s infinite alternate;
}
@keyframes pulse {
  from { transform: scale(1); }
  to { transform: scale(1.1); }
}

/* Timer */
.timer {
  font-size: 40px;
  font-weight: 900;
  color: var(--yellow);
  text-shadow: 0 0 10px black;
  margin-top: 30px;
}

/* Liste des joueurs */
.players {
  margin-top: 20px;
  width: 95%;
  height: 380px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  overflow-y: auto;
  scrollbar-width: none;
  padding-bottom: 10px;
}
.players::-webkit-scrollbar {
  display: none;
}

/* Carte joueur */
.player {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--card);
  border-radius: 14px;
  padding: 8px;
  border: 2px solid rgba(255,255,255,0.1);
}

.avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 22px;
  font-weight: 900;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 4px;
}

.name {
  font-weight: 700;
  font-size: 15px;
  text-align: center;
  word-break: break-word;
  color: var(--txt);
  margin-bottom: 6px;
}

.vote {
  background: var(--red);
  color: white;
  font-weight: 800;
  border: none;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  transition: 0.2s;
  width: 80%;
}
.vote:hover {
  transform: scale(1.05);
}
.vote.selected {
  background: var(--yellow);
  color: black;
}

/* Cacher les contrôles extension */
.ext-controls { display: none; }
.hidden { display: none; }
</style>
</head>
<body>
<div class="viewport">
  <div id="alert" class="alert">!</div>
  <div id="timer" class="timer"></div>
  <div id="players" class="players hidden"></div>

  <div class="ext-controls">
    <input class="input" type="text">
    <button class="send">Send!</button>
  </div>
</div>

<script>
/* === CONFIGURATION === */
const JOIN = 30;
const TALK = 60;
const VOTE = 20;

/* === ÉLÉMENTS === */
const alertEl = document.getElementById('alert');
const timerEl = document.getElementById('timer');
const playersEl = document.getElementById('players');
const extInput = document.querySelector('.input');
const extSend = document.querySelector('.send');

/* === VARIABLES === */
let stage = 'join';
let voteLocked = false;
let myVote = null;
let players = [];

/* === OUTILS === */
function formatTime(s) {
  const m = Math.floor(s/60);
  const sec = s % 60;
  return (m>0?m.toString().padStart(2,'0')+':':'') + sec.toString().padStart(2,'0');
}

function parsePlayers() {
  try {
    const params = new URLSearchParams(window.location.search);
    const raw = params.get('j');
    if (!raw) return [];
    const decoded = decodeURIComponent(raw);
    const arr = JSON.parse(decoded);
    if (Array.isArray(arr)) return arr;
  } catch (e) {
    console.error('Erreur de parsing des joueurs :', e);
  }
  return [];
}

/* === COULEURS STYLE AMONG US === */
function randomColor() {
  const colors = ['#ff595e','#4cc9f0','#ffd166','#90be6d','#f72585','#4361ee','#b5179e'];
  return colors[Math.floor(Math.random()*colors.length)];
}

/* === AFFICHAGE JOUEURS === */
function renderPlayers(votePhase=false) {
  playersEl.innerHTML = '';
  players.forEach(name => {
    const card = document.createElement('div');
    card.className = 'player';

    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.style.background = randomColor();
    avatar.textContent = name.charAt(0).toUpperCase();

    const nm = document.createElement('div');
    nm.className = 'name';
    nm.textContent = name;

    card.appendChild(avatar);
    card.appendChild(nm);

    if (votePhase) {
      const btn = document.createElement('button');
      btn.className = 'vote';
      btn.textContent = 'Voter';
      btn.onclick = () => {
        if (voteLocked) return;
        myVote = name;
        document.querySelectorAll('.vote').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      };
      card.appendChild(btn);
    }

    playersEl.appendChild(card);
  });
}

/* === COMPTE À REBOURS === */
function countdown(seconds, nextPhase) {
  timerEl.textContent = formatTime(seconds);
  const i = setInterval(()=>{
    seconds--;
    timerEl.textContent = formatTime(seconds);
    if (seconds <= 0) {
      clearInterval(i);
      nextPhase();
    }
  }, 1000);
}

/* === PHASES === */
function startJoin() {
  stage = 'join';
  playersEl.classList.add('hidden');
  alertEl.classList.remove('hidden');
  alertEl.textContent = '!';
  countdown(JOIN, startTalk);
}

function startTalk() {
  stage = 'talk';
  alertEl.classList.add('hidden');
  playersEl.classList.remove('hidden');
  renderPlayers(false);
  countdown(TALK, startVote);
}

function startVote() {
  stage = 'vote';
  renderPlayers(true);
  countdown(VOTE, endVote);
}

function endVote() {
  stage = 'end';
  voteLocked = true;
  alertEl.classList.remove('hidden');
  alertEl.textContent = '✔';
  playersEl.classList.add('hidden');
  timerEl.textContent = '';

  const result = myVote || 'SKIP';
  extInput.value = result;
  extSend.click();
  window.parent.postMessage(result, '*');
}

/* === INITIALISATION === */
window.addEventListener('load', () => {
  extInput.value = "load";
  extSend.click();
  window.parent.postMessage(result, '*');
  players = parsePlayers();
  startJoin();
});
</script>
</body>
</html>
