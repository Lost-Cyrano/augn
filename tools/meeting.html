<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=360, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Among Us Meeting</title>
<style>
:root {
  --w: 360px;
  --h: 640px;

  --join-seconds: 30;
  --talk-seconds: 60;
  --vote-seconds: 20;

  --red: #ff595e;
  --yellow: #ffd166;
  --blue: #4cc9f0;
  --green: #90be6d;
  --bg1: #0f1724;
  --bg2: #1b2a3a;
  --txt: #e6eef6;
}

html, body {
  margin: 0;
  height: 100%;
  background: radial-gradient(circle at bottom, var(--bg2) 0%, var(--bg1) 100%);
  overflow: hidden;
  font-family: 'Arial', sans-serif;
  color: var(--txt);
}

.viewport {
  width: var(--w);
  height: var(--h);
  border-radius: 20px;
  overflow: hidden;
  position: relative;
  margin: auto;
  box-shadow: 0 0 40px rgba(0,0,0,0.8);
  background: url('https://i.ibb.co/V9WZsmt/space-bg.jpg') center/cover no-repeat;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* Effet de fond animé (étoiles) */
.viewport::before {
  content: '';
  position: absolute;
  inset: 0;
  background: url('https://i.ibb.co/hYwsZkS/stars.png') repeat;
  animation: moveStars 60s linear infinite;
  opacity: 0.3;
}
@keyframes moveStars {
  from {background-position: 0 0;}
  to {background-position: -1000px 1000px;}
}

/* Alerte visuelle */
.alert {
  z-index: 2;
  width: 150px;
  height: 150px;
  border-radius: 50%;
  background: var(--red);
  box-shadow: 0 0 30px var(--red);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 72px;
  font-weight: 900;
  color: white;
  animation: pulse 0.8s infinite alternate;
}
@keyframes pulse {
  from {transform: scale(1);}
  to {transform: scale(1.15);}
}

/* Timer */
.timer {
  z-index: 2;
  font-size: 42px;
  font-weight: 900;
  color: var(--yellow);
  text-shadow: 0 0 10px black;
  margin-top: 20px;
}

/* Liste des joueurs */
.players {
  z-index: 2;
  width: 90%;
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow-y: auto;
  max-height: 300px;
  scrollbar-width: none;
}
.players::-webkit-scrollbar { display: none; }

.player {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(17,24,39,0.85);
  border: 2px solid rgba(255,255,255,0.1);
  border-radius: 14px;
  padding: 8px 12px;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.4);
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  color: white;
  text-shadow: 0 0 4px rgba(0,0,0,0.6);
  background: var(--blue);
  flex-shrink: 0;
}

.name {
  flex: 1;
  margin-left: 10px;
  font-weight: 700;
  font-size: 16px;
  text-shadow: 0 0 4px rgba(0,0,0,0.5);
}

.vote {
  background: var(--red);
  color: white;
  font-weight: 800;
  border: none;
  border-radius: 10px;
  padding: 8px 14px;
  font-size: 16px;
  transition: 0.2s;
  box-shadow: 0 0 10px rgba(255,0,0,0.3);
}
.vote:hover {
  transform: scale(1.05);
}
.vote.selected {
  background: var(--yellow);
  color: black;
  box-shadow: 0 0 15px rgba(255,255,0,0.4);
}

/* Cacher les contrôles de communication */
.ext-controls { display: none; }
.hidden { display: none; }
</style>
</head>
<body>
<div class="viewport">
  <div id="alert" class="alert">!</div>
  <div id="timer" class="timer"></div>
  <div id="players" class="players hidden"></div>

  <!-- Pour compatibilité extension -->
  <div class="ext-controls">
    <input class="input" type="text">
    <button class="send">Send!</button>
  </div>
</div>

<script>
/* === CONFIGURATION === */
const JOIN = 30;
const TALK = 60;
const VOTE = 20;

/* === ELEMENTS === */
const alertEl = document.getElementById('alert');
const timerEl = document.getElementById('timer');
const playersEl = document.getElementById('players');
const extInput = document.querySelector('.input');
const extSend = document.querySelector('.send');

/* === VARIABLES === */
let stage = 'join';
let voteLocked = false;
let myVote = null;
let players = [];

/* === UTILITAIRES === */
function formatTime(s) {
  const m = Math.floor(s/60);
  const sec = s % 60;
  return (m>0?m.toString().padStart(2,'0')+':':'') + sec.toString().padStart(2,'0');
}

function parsePlayers() {
  try {
    const params = new URLSearchParams(window.location.search);
    const raw = params.get('j');
    if (!raw) return [];
    const decoded = decodeURIComponent(raw);
    const arr = JSON.parse(decoded);
    if (Array.isArray(arr)) return arr;
  } catch (e) {
    console.error('Erreur de parsing des joueurs :', e);
  }
  return [];
}

/* === EFFET SONORE === */
function playAlert() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'square';
    osc.frequency.value = 880;
    gain.gain.value = 0.25;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    setTimeout(()=>osc.stop(), 500);
  } catch(e) {}
}

/* === COMPTE À REBOURS === */
function countdown(seconds, nextPhase) {
  timerEl.textContent = formatTime(seconds);
  const i = setInterval(()=>{
    seconds--;
    timerEl.textContent = formatTime(seconds);
    if (seconds <= 0) {
      clearInterval(i);
      nextPhase();
    }
  }, 1000);
}

/* === GÉNÉRATION COULEUR ALÉATOIRE (style Among Us) === */
function randomColor() {
  const colors = ['#ff595e','#4cc9f0','#ffd166','#90be6d','#f72585','#4361ee','#b5179e'];
  return colors[Math.floor(Math.random()*colors.length)];
}

/* === AFFICHAGE JOUEURS === */
function renderPlayers(votePhase=false) {
  playersEl.innerHTML = '';
  players.forEach(name => {
    const row = document.createElement('div');
    row.className = 'player';

    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.style.background = randomColor();
    avatar.textContent = name.charAt(0).toUpperCase();

    const nm = document.createElement('div');
    nm.className = 'name';
    nm.textContent = name;

    row.appendChild(avatar);
    row.appendChild(nm);

    if (votePhase) {
      const btn = document.createElement('button');
      btn.className = 'vote';
      btn.textContent = 'Voter';
      btn.onclick = () => {
        if (voteLocked) return;
        myVote = name;
        document.querySelectorAll('.vote').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      };
      row.appendChild(btn);
    }

    playersEl.appendChild(row);
  });
}

/* === PHASES === */
function startJoin() {
  stage = 'join';
  playersEl.classList.add('hidden');
  alertEl.classList.remove('hidden');
  alertEl.textContent = '!';
  playAlert();
  countdown(JOIN, startTalk);
}

function startTalk() {
  stage = 'talk';
  alertEl.classList.add('hidden');
  playersEl.classList.remove('hidden');
  renderPlayers(false);
  countdown(TALK, startVote);
}

function startVote() {
  stage = 'vote';
  renderPlayers(true);
  countdown(VOTE, endVote);
}

function endVote() {
  stage = 'end';
  voteLocked = true;
  alertEl.classList.remove('hidden');
  alertEl.textContent = '✔';
  playersEl.classList.add('hidden');
  timerEl.textContent = '';

  const result = myVote || 'SKIP';
  // ENVOI SIMPLE DU NOM SEUL
  extInput.value = result;
  extSend.click();
  window.parent.postMessage(result, '*');
}

/* === INITIALISATION === */
window.addEventListener('load', () => {
  players = parsePlayers();
  startJoin();
});
</script>
</body>
</html>
