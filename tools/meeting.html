<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=360, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AmongUs Meeting</title>
<style>
:root{
  --w:360px;
  --h:640px;
  --accent:#ff595e;
  --accent2:#ffd166;
  --bg1:#0f1724;
  --bg2:#1b2a3a;
  --txt:#e6eef6;
}

/* --- Layout général --- */
html,body{
  margin:0;
  height:100%;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  font-family:sans-serif;
  color:var(--txt);
  display:flex;
  align-items:center;
  justify-content:center;
}

.viewport{
  width:var(--w);
  height:var(--h);
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 0 30px rgba(0,0,0,.7);
  position:relative;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

.alert{
  width:120px;
  height:120px;
  border-radius:20px;
  background:var(--accent);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:60px;
  color:white;
  animation:pulse .8s infinite alternate;
}
@keyframes pulse{from{transform:scale(1)}to{transform:scale(1.15)}}

.timer{
  font-size:42px;
  font-weight:900;
  color:var(--accent2);
  margin-top:15px;
}

.players{
  width:90%;
  margin-top:30px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.player{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;
  padding:10px 14px;
}

.avatar{
  width:40px;
  height:40px;
  border-radius:8px;
  background:linear-gradient(180deg,#e05d62,#b71c1f);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:18px;
  color:white;
}

.name{
  flex:1;
  margin-left:10px;
  font-weight:700;
  font-size:16px;
}

.vote{
  background:var(--accent);
  color:white;
  font-weight:800;
  border:none;
  border-radius:10px;
  padding:10px 14px;
  font-size:16px;
  transition:.2s;
}
.vote.selected{
  background:var(--accent2);
  color:black;
}
.vote:active{transform:scale(.95)}

.hidden{display:none;}
.ext-controls{display:none;}
</style>
</head>
<body>
<div class="viewport">
  <div id="alert" class="alert">!</div>
  <div id="timer" class="timer"></div>
  <div id="players" class="players hidden"></div>

  <!-- pour compatibilité avec l'extension -->
  <div class="ext-controls">
    <input class="input" type="text">
    <button class="send">Send!</button>
  </div>
</div>

<script>
/* =============================
   CONFIGURATION RAPIDE
============================= */
const JOIN_DURATION = 10; // secondes pour rejoindre
const TALK_DURATION = 20; // secondes pour discuter
const VOTE_DURATION = 10; // secondes pour voter

/* =============================
   VARIABLES GLOBALES
============================= */
const alertEl = document.getElementById('alert');
const timerEl = document.getElementById('timer');
const playersEl = document.getElementById('players');
const extInput = document.querySelector('.input');
const extSend = document.querySelector('.send');

let stage = 'join';
let myVote = null;
let voteLocked = false;
let players = [];

/* =============================
   OUTILS
============================= */
function formatTime(sec){
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return (m>0?String(m).padStart(2,'0')+':':'')+String(s).padStart(2,'0');
}

function parsePlayers(){
  const params = new URLSearchParams(window.location.search);
  let raw = params.get('j');
  if(!raw) return [];
  try{
    raw = decodeURIComponent(raw);
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) return arr;
  }catch(e){ console.error("Paramètre j invalide :", e); }
  return [];
}

/* =============================
   SON D'ALERTE
============================= */
function playAlert(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'square';
    osc.frequency.value = 880;
    gain.gain.value = 0.2;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    setTimeout(()=>osc.stop(),500);
  }catch(e){}
}

/* =============================
   COMPTE À REBOURS
============================= */
function countdown(seconds, callback){
  timerEl.textContent = formatTime(seconds);
  const int = setInterval(()=>{
    seconds--;
    timerEl.textContent = formatTime(seconds);
    if(seconds <= 0){
      clearInterval(int);
      callback();
    }
  },1000);
}

/* =============================
   AFFICHAGE DES JOUEURS
============================= */
function renderPlayers(votePhase=false){
  playersEl.innerHTML = '';
  players.forEach(name=>{
    const row = document.createElement('div');
    row.className = 'player';
    const av = document.createElement('div');
    av.className = 'avatar';
    av.textContent = name.charAt(0).toUpperCase();
    const nm = document.createElement('div');
    nm.className = 'name';
    nm.textContent = name;
    row.appendChild(av);
    row.appendChild(nm);

    if(votePhase){
      const btn = document.createElement('button');
      btn.className = 'vote';
      btn.textContent = 'Voter';
      btn.onclick = ()=>{
        if(voteLocked) return;
        myVote = name;
        document.querySelectorAll('.vote').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
      };
      row.appendChild(btn);
    }
    playersEl.appendChild(row);
  });
}

/* =============================
   FLUX PRINCIPAL
============================= */
function startJoin(){
  stage = 'join';
  playersEl.classList.add('hidden');
  alertEl.classList.remove('hidden');
  alertEl.textContent = '!';
  playAlert();
  countdown(JOIN_DURATION, startTalk);
}

function startTalk(){
  stage = 'talk';
  alertEl.classList.add('hidden');
  playersEl.classList.remove('hidden');
  renderPlayers(false);
  countdown(TALK_DURATION, startVote);
}

function startVote(){
  stage = 'vote';
  renderPlayers(true);
  countdown(VOTE_DURATION, endVote);
}

function endVote(){
  stage = 'end';
  voteLocked = true;
  alertEl.classList.remove('hidden');
  alertEl.textContent = '✔';
  playersEl.classList.add('hidden');
  timerEl.textContent = '';

  const result = myVote || 'SKIP';
  // communication vers le parent et l'extension
  extInput.value = result;
  extSend.click();
  window.parent.postMessage({ type: 'amongus_vote', vote: result }, '*');
}

/* =============================
   INITIALISATION
============================= */
window.addEventListener('load', ()=>{
  players = parsePlayers();
  startJoin();
});
</script>
</body>
</html>
